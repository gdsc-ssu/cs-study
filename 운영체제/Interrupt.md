# 🙋‍♀️🙋‍♂️ 인터럽트(Interrupt)

## 🐸 인터럽트(Interrupt)란?

- 인터럽트는 `컴퓨터구조` 및 `OS`에서 정말 많이 나오는 키워드이다.
- CPU가 프로그램을 실행하고 있을 때, **입출력** 하드웨어 등의 장치나 **예외 상황**이 발생하여 처리가 필요할 경우에 `마이크로프로세서(micro processor)`에게 알려 처리할 수 있도록 하는 것
  - 가령 교수가 강의를 하던 도중 한 학생이 질문을 했고, 교수는 학생의 질문에 답변을 한 후 강의를 이어나간다고 하자.
  - 이때, 학생이 질문을 한 행위를 `인터럽트(Interrupt)`라고 할 수 있다.
    - 교수가 강의를 진행 -> CPU가 프로그램을 실행
    - 학생이 질문 -> 예외 상황 발생 전달 : `인터럽트(Interrupt)`
    - 교수가 질문에 답변 후 다시 강의 -> CPU가 처리 후 다시 프로그램 실행

### ❓ 인터럽트(Interrupt)를 사용하는 이유

- 입출력 연산의 경우, CPU 명령 수행속도에 비해 현저히 느리다.
- 때문에 CPU를 효율적으로 사용하기 위해 사용한다.

## 🐸 인터럽트(Interrupt)의 종류

### 🐾 소프트웨어 인터럽트 (내부 인터럽트)

- 소프트웨어가 발생시키는 인터럽트
- 소프트웨어가 `인터럽트 라인`을 세팅하여, 인터럽트를 발생시킨다.
  - 프로그램 오류
    - 실행할 수 없는 명령어
    - 명령어 실행 오류
  - System Call 호출
  - 사용 권한 위배
    - 사용자가 운영체제만 사용할 수 있는 자원에 접근할 경우에
  - 하드웨어 고장
    - 컴퓨터 고장
    - 데이터 전달 과정에서의 비트 오류
    - 전원 Out
      > 하드웨어 고장은 소프트웨어 인터럽트이다.

### 🐾 하드웨어 인터럽트 (외부 인터럽트)

- 하드웨어가 발생시키는 인터럽트
- CPU가 아닌 다른 장치가 CPU에게 어떤 사실을 알려주거나 CPU 서비스를 요청하는 경우에 발생된다.
- 주로 `입출력 장치`에 의해 발생된다.
  - 타이머 인터럽트
    - 타이머가 일정한 시간 간격으로 중앙처리장치에게 인터럽트를 요청
  - 입출력 인터럽트
    - 속도가 느린 입출력장치가 입출력 준비가 완료되었음을 알리기 위해 인터럽트를 요청

## 🐸 인터럽트(Interrupt) 처리 과정

### 🐾 용어 정리

- **인터럽트 핸들러 (인터럽트 서비스 루틴)**
  - 루틴이란, 반복적으로 수행하는 일을 의미함.
  - 인터럽트 처리과정에서 어떤 소스(Source)가 인터럽트 요청을 할 때, 반복적으로 수행해야 하는 일.
    - 소스마다 처리를 요청하는 일이 다르기 때문에, 서로 다른 루틴들은 기억장치에 저장되어있다.
    - 즉 `인터럽트 서비스 루틴` 역시 프로그램의 일종이다.
- **인터럽트 벡터**
  - 위에서 언급한 인터럽트 서비스 루틴의 주소를 보관하고 있는 테이블이다.
- **PCB(Process Control Block)**
  - 인터럽트 발생 시, 프로세스의 어느 부분이 수행 중이었는지 저장되어있는 블록.
    - 수행 중이던 memory 주소
    - 레지스터 값
    - 하드웨어 상태
  - 커널의 데이터 영역에 존재함.

### 🐾 처리 과정

![image](https://i.imgur.com/MD4NrLz.png)

- 명령어 사이클은 `인출(fetch stage)`와 `실행(execution stage)` 두 가지 단계를 반복해서 수행
- 인터럽트 요청이 들어왔을 때 바로 처리하는 것 X
  1. 명령어 N의 실행 단계를 마쳐야함
  2. 명령어 실행 단계를 마칠 때 마다, 중앙처리장치는 반복적으로 인터럽트 요청이 있는지 계속해서 확인
  3. 인터럽트 요청이 있어야 인터럽트 서비스 단계를 진행

<br/>![image](https://i.imgur.com/sA0vHHB.png)

1. process A는 system call을 통해 인터럽트를 발생시킨다.
2. CPU는 현재 진행 중인 기계어 코드를 완료한다.
3. 현재까지 수행중이었던 상태를 해당 process의 `PCB(Process Control Block)`에 저장한다.
4. PC(Program Counter, IP)에 다음에 실행할 명령의 주소를 저장한다.
5. 인터럽트 벡터를 읽고 ISR 주소값을 얻어 `ISR(Interrupt Service Routine)`로 점프하여 루틴을 실행한다.
6. 해당 코드를 실행한다.
7. 해당 일을 다 처리하면, 대피시킨 레지스터를 복원한다.
8. ISR의 끝에 IRET 명령어에 의해 인터럽트가 해제 된다.
9. IRET 명령어가 실행되면, 대피시킨 PC 값을 복원하여 이전 실행 위치로 복원한다.

## 🐸 인터럽트와 명령

### 🐾 명령어

- **일반 명령**
  - 모든 프로그램이 수행가능한 명령
    - 메모리에서 자료 읽기
    - CPU에서 계산하기
- **특권 명령**
  - 보안이 필요한 명령. 운영체제만이 수행 가능.
    - 입출력 장치 접근
    - 타이머 장치 접근
- **Kernel Mode**
  - 운영체제가 CPU 제어권을 갖고 명령어를 수행하는 모드
  - `일반 명령`과 `특권 명령` 모두 가능
- **User Mode**
  - 일반 사용자 프로그램이 CPU 제어권을 갖고 명령을 수행하는 모드
  - `일반 명령`만 수행 가능

### 🐾 시스템 콜 (System Call)

- `User Mode`에서 운영체제의 서비스를 받기 위해 커널 함수를 호출하는 것
- 제어권이 운영체제에로 넘어감

### 🐾 I/O

- I/O 명령은 특권 명령이기 때문에 사용자 모드 프로그램에서는 I/O명령을 처리하지 못함.
- 그래서 사용자 프로그램은 커널 함수를 호출하는 system call을 이용함.
  1. 사용자 프로그램이 운영체제에게 시스템 콜을 한다.
  2. 소프트웨어 인터럽트를 통해 인터럽트 벡터의 위치로 이동한다.
  3. 제어권이 인터럽트 벡터가 가르키는 인터럽트 서비스 루틴으로 이동한다.
  4. 올바른 I/O 작업인지 확인 후, 실제 I/O를 수행한다.

## 🔍 참고자료

### 내용 및 이미지 참고

- [[컴퓨터구조] 인터럽트(Interrupt)란?](https://whatisthenext.tistory.com/147)
- [[OS기초] 인터럽트 제대로 이해하기](https://velog.io/@adam2/%EC%9D%B8%ED%84%B0%EB%9F%BD%ED%8A%B8)
- [CS-Free-study/CS-Study - Interrupt.md](https://github.com/CS-Free-study/CS-Study/blob/main/contents/operating-system/Interrupt.md)
